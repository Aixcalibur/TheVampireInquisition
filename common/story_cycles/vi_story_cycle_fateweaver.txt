story_vi_fateweaver = {

	on_setup = {
		scope:story = {
			set_variable = { name = vi_vamp_master value = story_owner }
		}
	}

	on_end = {

	}

	on_owner_death = {
		var:destiny_child = {
			send_interface_toast = {
				title = vi_fateunraveled_msg
				right_icon = scope:story.var:vi_vamp_master
			}
			if = {
				limit = {
					is_alive = yes
				}
				remove_character_modifier = bp2_destined_modifier
				add_character_modifier = {
					modifier = vi_fateunraveled_modifier
				}
			}
		}
		end_story = yes
	}

	# Something happens - random events

	effect_group = {
		days = 30
		trigger = {
			always = yes
		}
		triggered_effect = {
			trigger = {
				OR = {
					NOT = {
						exists = var:destiny_child
					}
					var:destiny_child = {
						is_alive = no
					}
					var:destiny_child = {
						is_courtier_of = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						has_relation_ward = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						liege = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						is_spouse_of = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						house = scope:story.var:vi_vamp_master.house
					}
				}
			}
			effect = {
				story_owner = {
					send_interface_toast = {
						title = vi_fateunraveled_msg
						right_icon = scope:story.var:destiny_child
						scope:story.var:destiny_child = {
							if = {
								limit = {
									is_alive = yes
								}
								remove_character_modifier = bp2_destined_modifier
								add_character_modifier = {
									modifier = vi_fateunraveled_modifier
								}
							}
						}
					}
				}
				end_story = yes
			}
		}
	}

	effect_group = {
		days = 365
		trigger = {
			var:destiny_child = {
				is_adult = no
			}
		}

		first_valid = {
			triggered_effect = {
				trigger = {
					story_owner = {
						has_bp2_dlc_trigger = yes
					}
					var:destiny_child = {
						NOT = {
							has_character_modifier = bp2_destined_modifier
						}
						age >= 8
						age < 12
					}
				}
				effect = {
					var:destiny_child = {

						save_scope_as = destiny_child

						liege_or_court_owner = {
							save_scope_as = vi_destiny_story_owner
						}
					}

					scope:destiny_child = {
						add_character_modifier = {
							modifier = bp2_destined_modifier
						}
						set_variable = {
							name = destiny_child
							value = scope:destiny_child
						}
					}

					if = {
						limit = {
							exists = scope:vi_destiny_story_owner
						}
						scope:vi_destiny_story_owner = {
							create_story = {
								type = story_destiny_child
								save_scope_as = story
							}

							random_owned_story = {
								limit = {
									story_type = story_destiny_child
								}
								set_variable = {
									name = destiny_child
									value = scope:destiny_child
								}
							}
						}
					}

				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age >= 7
						NOT = {
							has_trait = ambitious
						}
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = content
						add_trait = ambitious
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = lazy
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = lazy
						add_trait = patient
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = craven
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = craven
						add_trait = cynical
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = shy
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = shy
						add_trait = calm
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = paranoid
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = paranoid
						add_trait = diligent
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age > 13
						NOT = {
							has_trait = strong
						}
					}
				}
				effect = {
					var:destiny_child = {
						add_trait = strong
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age > 13
						NOT = {
							has_trait = shrewd
						}
					}
				}
				effect = {
					var:destiny_child = {
						add_trait = shrewd
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age >= 14
						NOT = {
							has_trait = shrewd
						}
					}
				}
				effect = {
					var:destiny_child = {
						add_trait = shrewd
					}
				}
			}
		}
	}

	effect_group = {
		days = {300 600}
		trigger = {
			var:destiny_child = {
				is_adult = yes
			}
		}
		first_valid = {
			# Independent ruler, sufficient strength, sufficient title tier
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_independent_ruler = yes
						is_landed = yes
						current_military_strength >= 4000
						highest_held_title_tier > tier_county
					}
				}
				effect = {
					var:destiny_child = {
						if = {
							limit = {
								NOT = {
									owns_story_of_type = story_conqueror
								}
							}
							trigger_event = conqueror.0001
						}
					}
					story_owner = {
						send_interface_toast = {
							title = vi_fateachieved_msg
							left_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = {
								show_as_tooltip = {
									add_trait = conqueror
								}
							}
							add_vi_vampire_lifestyle_xp = 1000
						}
					}
					# just to be sure
					root = { end_story = yes }
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_ruler = yes
						is_landed = yes
						OR = {
							is_independent_ruler = no
							is_tributary = yes
						}
						is_at_war = no
						OR = {
							liege = {
								prev.current_military_strength >= {
									value = {
										value = max_military_strength
										multiply = 1.2
									}
								}
							}
							suzerain = {
								prev.current_military_strength >= {
									value = {
										value = max_military_strength
										multiply = 1.2
									}
								}
							}
						}
					}
				}
				effect = {
					story_owner = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = {
								if = {
									limit = {
										exists = liege
									}
									start_war = {
										cb = independence_war
										target = scope:story.var:destiny_child.liege
									}
								} else = {
									start_war = {
										cb = tributary_independence_war
										target = scope:story.var:destiny_child.suzerain
									}
								}
							}
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_ruler = yes
						is_landed = yes
						is_independent_ruler = yes
						is_tributary = no
						highest_held_title_tier <= tier_county
						is_at_war = no
					}
				}
				effect = {
					var:destiny_child = {
						vi_buff_destiny_child = yes
						vi_empower_maa = yes
						vi_spawn_army = yes
						if = {
							limit = {
								exists = capital_province.duchy.holder
							}
							add_pressed_claim = capital_province.duchy
							if = {
								limit = {
									scope:story.var:destiny_child = {
										has_truce = capital_province.duchy.holder
									}
								}
								cancel_truce_both_ways = capital_province.duchy.holder
							}
							start_war = {
								cb = claim_cb
								target = capital_province.duchy.holder
								claimant = scope:story.var:destiny_child
								target_title = capital_province.duchy
								target_title = capital_province.duchy.title_capital_county
							}
						}
						else_if = {
							limit = {
								OR = {
									any_alert_creatable_title = {
										duchy = scope:story.var:destiny_child.capital_province.duchy
									}
									any_alert_usurpable_title = {
										duchy = scope:story.var:destiny_child.capital_province.duchy
									}
								}
							}
							capital_province.duchy = {
								create_title_and_vassal_change = {
									type = usurped
									save_scope_as = change
									add_claim_on_loss = yes
								}
								change_title_holder_include_vassals = {
									holder = scope:story.var:destiny_child
									change = scope:change
								}
								resolve_title_and_vassal_change = scope:change
							}
						}
						else = {
							scope:story.var:destiny_child = {
								create_dynamic_title = {
									tier = duchy
									name = NEW_CREATED_TITLE_NAME
								}
								create_title_and_vassal_change = {
									type = created
									save_scope_as = change
									add_claim_on_loss = no
								}

								scope:new_title = {
									set_destroy_on_gain_same_tier = yes
									set_no_automatic_claims = yes
									set_can_be_named_after_dynasty = no
									change_title_holder = {
										holder = scope:story.var:destiny_child
										change = scope:change
									}
								}

								resolve_title_and_vassal_change = scope:change
								scope:new_title = { generate_coa = yes }
							}
						}
					}
					story_owner = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_ruler = yes
						is_landed = yes
					}
				}
				effect = {
					scope:story.var:vi_vamp_master = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = { vi_buff_destiny_child = yes vi_empower_maa = yes }
						}
					}
					scope:story.var:destiny_child = { vi_spawn_army = yes }
					if = {
						limit = {
							scope:story.var:destiny_child = { AND = {
								exists = liege
								is_primary_heir_of = liege
							}}
						}
						scope:story.var:vi_vamp_master = {
							send_interface_message = {
								title = vi_dcneedshelp_msg
								right_icon = scope:story.var:destiny_child
							}
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					story_owner = {
						has_dlc_feature = roads_to_power
					}
					var:destiny_child = {
						is_ruler = yes
						is_landless_ruler = yes
					}
				}
				effect = {
					scope:story.var:vi_vamp_master = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = { vi_buff_destiny_child = yes vi_empower_maa = yes }
						}
					}
					scope:story.var:destiny_child = { vi_spawn_army = yes }
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_ruler = no
						exists = liege
						is_primary_heir_of = liege
						liege = { is_landless_ruler = no }
					}
				}
				effect = {
					story_owner = {
						send_interface_message = {
							title = vi_dcneedshelp_msg
							right_icon = scope:story.var:destiny_child
							random = {
								chance = 50
								scope:story.var:destiny_child = { vi_buff_destiny_child = yes }
							}
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					story_owner = {
						has_dlc_feature = roads_to_power
					}
					var:destiny_child = {
						is_ruler = no
					}
				}
				effect = {
					var:destiny_child = {
						if = {
							limit = {
								OR = {
									NOT = { exists = liege_or_court_owner }
									liege_or_court_owner = {
										is_landless_ruler = yes
									}
								}
							}
							save_scope_as = host
						}
						else = {
							liege_or_court_owner = {
								save_scope_as = host
							}
						}
						trigger_event = vi_fateweaver.0001
					}
					story_owner = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = { vi_buff_destiny_child = yes vi_empower_maa = yes }
						}
					}
					scope:story.var:destiny_child = { vi_spawn_army = yes }
				}
			}
			triggered_effect = {
				trigger = {
					always = yes
				}
				effect = {
					var:destiny_child = {
						vi_buff_destiny_child = yes
					}
				}
			}
		}
	}
}