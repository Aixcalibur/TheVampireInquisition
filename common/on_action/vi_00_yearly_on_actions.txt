yearly_global_pulse = {
	on_actions = {
		delay = {
			days = { 10 90 }
		}
		vi_awaken_archangel_pulse
	}
}

yearly_playable_pulse = {
	on_actions = {
		vi_vampire_playable_pulse
		# vi_vampire_friendship_pulse
	}
}

five_year_everyone_pulse = {
	on_actions = {
		vi_vampire_maintenance_pulse
	}
}

vi_vampire_playable_pulse = {
	trigger = {
		vi_is_vampire_trigger = yes
	}

	on_actions = {
		vi_vampire_landed_tracking
		vi_vampire_policy_pulse
	}
}

vi_vampire_landed_tracking = {
	trigger = {
		is_landed = yes
		NOT = {
			owns_story_of_type = story_vi_landed
		}
	}
	effect = {
		create_story = story_vi_landed
	}
}

vi_vampire_policy_pulse = {
	trigger = {
		has_government = vi_vampire_government
		is_landless_ruler = yes

		NOT = {
			has_character_flag = vi_vampire_policy_decided
		}

		any_held_title = {
			NOT = {
				has_title_law = noble_family_succession_law
			}
		}
	}

	effect = {
		vi_slow_regeneration_effect = yes
		if = {
			limit = {
				OR = {
					has_character_flag = vi_newly_landed
					has_character_flag = vi_land_tracked
				}
			}
			remove_character_flag = vi_newly_landed
			remove_character_flag = vi_land_tracked
		}
	}

	events = {
		vi_vampire_policy.001
	}
}

#Later, we'll make the upgrade process more sophisticated, but for now, we'll just do age upgrades
vi_vampire_maintenance_pulse = {
	trigger = {
		vi_is_vampire_trigger = yes
	}
	on_actions = {
		vi_vampire_upgrade_fledgling
		vi_vampire_upgrade_vampire
		vi_vampire_upgrade_elder
	}

	effect = {
		vi_slow_regeneration_effect = yes
		save_scope_as = vi_vampire
		if = {
			limit = {
				is_courtier = yes
				liege_or_court_owner = {
					vi_is_vampire_trigger = no
				}
				NOT = {
					any_known_secret = {
						secret_type = secret_vi_vampire
						secret_owner = scope:vi_vampire
					}
				}
			}
			
			liege_or_court_owner = {
				send_interface_message = {
					title = vi_suspicious_behavior_msg
					right_icon = scope:vi_vampire
					random_list = {
						10 = {
							custom_tooltip = vi_suspicious_behavior_tt
						}
						10 = {
							custom_tooltip = vi_suspicious_behavior_tt_1
						}
					}
					
					add_stress = miniscule_stress_gain
					add_opinion = {
						target = scope:vi_vampire
						modifier = suspicion_opinion
						opinion = -10
					}
				}
			}
		}

		every_relation = {
			limit = {
				NOT = {
					this = scope:vi_vampire.liege_or_court_owner
				}
				vi_is_vampire_trigger = no
				NOT = {
					any_known_secret = {
						secret_type = secret_vi_vampire
						secret_owner = scope:vi_vampire
					}
				}
			}
			send_interface_message = {
				title = vi_suspicious_behavior_msg
				right_icon = scope:vi_vampire
				random_list = {
					10 = {
						custom_tooltip = vi_suspicious_behavior_tt
					}
					10 = {
						custom_tooltip = vi_suspicious_behavior_tt_1
					}
				}
				add_stress = miniscule_stress_gain
				add_opinion = {
					target = scope:vi_vampire
					modifier = suspicion_opinion
					opinion = -10
				}
			}
		}

		random = {
			chance = 50
			vi_consider_excommunicated_list = yes
		}
	}
}

vi_vampire_upgrade_fledgling = {
	trigger = {
		NOT = {
			has_character_modifier = vi_skittish_modifier
		}
		NOR = {
			has_trait = vi_vampire_2
			has_trait = vi_vampire_3
			has_trait = vi_vampire_4
			has_trait = vi_vampire_5
		}
	}

	effect = {
		add_trait = vi_vampire_2
		remove_trait = vi_vampire_1
	}
}

vi_vampire_upgrade_vampire = {
	trigger = {
		has_trait = vi_vampire_2
		age >= 240
	}

	effect = {
		add_trait = vi_vampire_3
		remove_trait = vi_vampire_2
	}
}

vi_vampire_upgrade_elder = {
	trigger = {
		has_trait = vi_vampire_3
		age >= 600
	}

	effect = {
		add_trait = vi_vampire_4
		remove_trait = vi_vampire_3
	}
}