story_vi_fateweaver = {
	
	on_setup = {
		debug_log = "_FATEWEAVER_Fateweaving started"
		debug_log_scopes = yes
		scope:story = {
			set_variable = { name = vi_vamp_master value = story_owner }
		}
	}
	
	on_end = {
		
	}
	
	on_owner_death = {
		var:destiny_child = {
			send_interface_toast = {
				title = vi_fateunraveled_msg
				right_icon = scope:story.var:vi_vamp_master
			}
			if = {
				limit = {
					is_alive = yes
				}
				remove_character_modifier = bp2_destined_modifier
				add_character_modifier = {
					modifier = vi_fateunraveled_modifier
				}
			}
		}
		end_story = yes
	}
	
	# Something happens - random events

	effect_group = {
		days = 30
		trigger = {
			always = yes
		}
		triggered_effect = {
			trigger = {
				OR = {
					NOT = {
						exists = var:destiny_child
					}
					var:destiny_child = {
						is_alive = no
					}
					var:destiny_child = {
						is_courtier_of = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						has_relation_ward = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						liege = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						is_spouse_of = scope:story.var:vi_vamp_master
					}
					var:destiny_child = {
						house = scope:story.var:vi_vamp_master.house
					}
				}
			}
			effect = {
				debug_log = "_FATEWEAVER_Fateweaving ended"
				debug_log_scopes = yes
				story_owner = {
					send_interface_toast = {
						title = vi_fateunraveled_msg
						right_icon = scope:story.var:destiny_child
						scope:story.var:destiny_child = {
							if = {
								limit = {
									is_alive = yes
								}
								remove_character_modifier = bp2_destined_modifier
								add_character_modifier = {
									modifier = vi_fateunraveled_modifier
								}
							}
						}
					}
				}
				end_story = yes
			}
		}
	}

	effect_group = {
		days = 365
		trigger = {
			var:destiny_child = {
				is_adult = no
			}
		}

		first_valid = {
			triggered_effect = {
				trigger = {
					story_owner = {
						has_bp2_dlc_trigger = yes
					}
					var:destiny_child = {
						NOT = {
							has_character_modifier = bp2_destined_modifier
						}
						age >= 8
						age < 12
					}
				}
				effect = {
					var:destiny_child = {

						save_scope_as = destiny_child

						liege_or_court_owner = {
							save_scope_as = vi_destiny_story_owner
						}
					}

					scope:destiny_child = {
						add_character_modifier = {
							modifier = bp2_destined_modifier
						}
						set_variable = {
							name = destiny_child
							value = scope:destiny_child
						}
					}

					if = {
						limit = {
							exists = scope:vi_destiny_story_owner
						}
						scope:vi_destiny_story_owner = {
							create_story = {
								type = story_destiny_child
								save_scope_as = story
							}
					
							random_owned_story = {
								limit = {
									story_type = story_destiny_child
								}
								set_variable = {
									name = destiny_child
									value = scope:destiny_child
								}
							}
						}
					}
					
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age >= 7
						NOT = {
							has_trait = ambitious
						}
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = content
						add_trait = ambitious
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = lazy
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = lazy
						add_trait = patient
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = craven
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = craven
						add_trait = cynical
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = shy
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = shy
						add_trait = calm
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						has_trait = paranoid
					}
				}
				effect = {
					var:destiny_child = {
						remove_trait = paranoid
						add_trait = diligent
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age > 13
						NOT = {
							has_trait = strong
						}
					}
				}
				effect = {
					var:destiny_child = {
						add_trait = strong
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age > 13
						NOT = {
							has_trait = shrewd
						}
					}
				}
				effect = {
					var:destiny_child = {
						add_trait = shrewd
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						age >= 14
						NOT = {
							has_trait = shrewd
						}
					}
				}
				effect = {
					var:destiny_child = {
						add_trait = shrewd
					}
				}
			}
		}
	}

	effect_group = {
		days = {300 600}
		trigger = {
			var:destiny_child = {
				is_adult = yes
			}
		}

		first_valid = {
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_independent_ruler = yes
						is_landed = yes
						current_military_strength >= 3000
					}
				}
				effect = {
					var:destiny_child = {
						if = {
							limit = {
								NOT = {
									owns_story_of_type = story_conqueror
								}
							}
							create_story = story_conqueror
						}
					}
					story_owner = {
						send_interface_toast = {
							title = vi_fateachieved_msg
							left_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = {
								show_as_tooltip = {
									add_trait = conqueror
								}
							}
							add_vi_vampire_lifestyle_xp = 1000
						}
					}

					end_story = yes
				}
			}
			triggered_effect = {
				trigger = {
					story_owner = {
						has_dlc_feature = roads_to_power
					}
					var:destiny_child = {
						is_ruler = no
					}
				}
				effect = {
					var:destiny_child = {
						if = {
							limit = {
								OR = {
									NOT = { exists = liege_or_court_owner }
									liege_or_court_owner = {
										is_landless_ruler = yes
									}
								}
							}
							save_scope_as = host
						}
						else = {
							liege_or_court_owner = {
								save_scope_as = host
							}
						}
						trigger_event = vi_fateweaver.0001
					}
					story_owner = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							scope:story.var:destiny_child = {
								create_landless_adventurer_title_tooltip_effect = yes
								add_gold = 200
							}
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					story_owner = {
						has_dlc_feature = roads_to_power
					}
					var:destiny_child = {
						is_ruler = yes
						is_landless_ruler = yes
					}
				}
				effect = {
					var:destiny_child = {
						scope:story.var:vi_vamp_master = {
							send_interface_message = {
								title = vi_fateinfluence_msg
								right_icon = scope:story.var:destiny_child
								scope:story.var:destiny_child = { add_short_term_gold = 50 }
								scope:story.var:destiny_child = { add_war_chest_gold = 100 }
								scope:story.var:destiny_child = { add_stress = medium_stress_loss }
							}
						}
						every_maa_regiment = {
							limit = {
								is_maa_in_combat = no
								can_upgrade_maa = yes
							}
							change_maa_regiment_size = {
								size = 1
								reinforce = yes
							}
						}
						if = {
							limit = {
								maa_regiments_count < maa_regiments_max_count
							}
							send_interface_message = {
								title = vi_fateinfluence_msg
								right_icon = scope:story.var:destiny_child
								random_list = {
									50 = {
										create_maa_regiment = {
											type = handpicked_faithful
											check_can_recruit = no
											size = 1
										}
									}
									50 = {
										if = {
											limit = {
												NOT = {
													any_maa_regiment = {
														is_unit_type = siege_weapon
													}
												}
											}
											create_maa_regiment = {
												type = onager
												check_can_recruit = no
												size = 1
											}
										}
										else = {
											create_maa_regiment = {
												type = varangian_guards
												check_can_recruit = no
												size = 1
											}
										}
									}
								}
							}
						}
						else = {
							send_interface_message = {
								title = vi_fateinfluence_msg
								right_icon = scope:story.var:destiny_child
								random_list = {
									10 = {
										scope:story.var:destiny_child = { add_martial_skill = 1 }
									}
									10 = {
										scope:story.var:destiny_child = { 
											if = {
												limit = {
													has_trait = military_engineer
												}
												add_trait_xp = {
													trait = military_engineer
													value = 11
												}
											} else = {
												add_trait = military_engineer
											}
										}
									}
									10 = {
										scope:story.var:destiny_child = { 
											if = {
												limit = {
													has_trait = organizer
												}
												add_trait_xp = {
													trait = organizer
													value = 11
												}
											} else = {
												add_trait = organizer
											}
										}
									}
								}
							}
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					var:destiny_child = {
						is_ruler = yes	
						is_landed = yes
					}
				}
				effect = {
					set_local_variable = {
						name = troopsize
						value = {
							value = 100
							multiply = var:destiny_child.primary_title.tier
						}
					}
					save_scope_value_as = {
						name = reinforcements
						value = local_var:troopsize
					}

					scope:story.var:destiny_child = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							add_short_term_gold = 150
							add_stress = medium_stress_loss
							spawn_army = {
								levies = scope:reinforcements
								men_at_arms = {
									type = handpicked_faithful
									men = scope:reinforcements
								}
								location = scope:story.var:destiny_child.capital_province
								name = event_troop_default_name
							}
						}
					}

					scope:story.var:vi_vamp_master = {
						send_interface_message = {
							title = vi_fateinfluence_msg
							right_icon = scope:story.var:destiny_child
							add_short_term_gold = 150
							add_stress = medium_stress_loss
							spawn_army = {
								levies = scope:reinforcements
								men_at_arms = {
									type = handpicked_faithful
									men = scope:reinforcements
								}
								location = scope:story.var:destiny_child.capital_province
								name = event_troop_default_name
							}
						}
					}
				}
			}
			triggered_effect = {
				trigger = {
					always = yes
				}
				effect = {
					var:destiny_child = {
						random_list = {
							50 = {
								add_gold = 50
							}
							50 = {
								add_stress = minor_stress_loss
							}
							20 = {
								add_martial_skill = 1
							}
						}
					}
				}
			}
		}
	}
}