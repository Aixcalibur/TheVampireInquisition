namespace = vi_fake_succession

vi_fake_succession.0001 = {
	type = character_event
	title = vi_fake_succession.0001.t
	desc = vi_fake_succession.0001.desc
	theme = realm
	#override_background = { reference = docks }
	
	left_portrait = {
		character = root
		animation = debating
	}
	# right_portrait = {
	# 	character = scope:aide
	# 	animation = scepter
	# }

	option = { #Use the city's native capabilities to produce what's needed
		name = vi_fake_succession.0001.a
		save_scope_as = actor

		add_character_flag = {
			flag = fake_succession_decision_flag
			years = 10
		}

		# start_scheme = {
		# 	type = vi_fake_succession_scheme
		# 	target_character = root
		# }
		
		begin_scheme_with_agents_effect = {
			SCHEME_TYPE = vi_fake_succession_scheme
			TARGET_TYPE = target_character
			TARGET_SCOPE = root
			# Success.
			AGENT_1 = agent_physic
			AGENT_2 = agent_diplomat
			AGENT_3 = agent_cleric_success
			AGENT_4 = agent_scribe
			# Speed.
			AGENT_5 = agent_planner
		}

		ai_chance = {
			base = 100	
		}
	}
	option = { #Actually... never mind
		name = vi_fake_succession.0001.b
		#remove_decision_cooldown = vi_fake_succession_decision
		
		ai_chance = {
			base = 0
			
		}
	}
}

vi_fake_succession.1001 = {
	hidden = yes

	immediate = {
		scope:scheme = {
			scheme_owner = {
				save_scope_as = owner
				#SUCCESS ROLL
				random = {
					chance = scope:scheme.scheme_success_chance
					save_scope_value_as = {
						name = scheme_successful
						value = yes
					}
				}
				if = {
					limit = { exists = scope:scheme_successful }
					trigger_event = {
						id = vi_fake_succession.2010
						days = 1
					}
				}
				else = {
					trigger_event = {
						id = vi_fake_succession.2020
						days = 1
					}	
				}
			}
		}
	}
}

# Success
vi_fake_succession.2010 = {
	type = character_event
	title = vi_fake_succession.2010.t
	desc = vi_fake_succession.2010.desc
	theme = realm
	left_portrait = {
		character = root
		animation = personality_bold
	}
	
	# Option A: Original succession effect
	option = {
		name = vi_fake_succession.2010.a
		vi_fake_succession_success_effect = yes
	}

	# Option B: New identity effect	
	option = {
		name = vi_fake_succession.2010.b
		trigger_event = {
			id = vi_fake_succession.2011
			delayed = yes
		}
	}
}

vi_fake_succession.2011 = {
	type = character_event
	title = vi_fake_succession.2011.t
	desc = vi_fake_succession.2011.desc
	theme = realm

	save_scope_as = original_identity

	immediate = {
		create_character = {
			age = scope:original_identity.age
			employer = scope:original_identity
			gender = scope:original_identity
			mother = scope:original_identity
			dynasty_house = scope:original_identity.house
			culture = scope:original_identity.culture
			faith = scope:original_identity.faith
			random_traits = no
			martial = 0
			diplomacy = 0
			intrigue = 0
			stewardship = 0
			learning = 0
			prowess = 0
			
			after_creation = {
				# Save the newly created character
				save_scope_as = new_identity
				
				# Protect original_identity from vanilla copy side-effects
				scope:original_identity = { save_scope_as = source_character }

				copy_inheritable_appearance_from = scope:source_character # vanilla effect
				copy_traits = scope:source_character # vanilla effect
				copy_genetics = yes	# in vi_fake_succession_effects line 191
				copy_sexuality = yes # in vi_fake_succession_effects line 2169
				copy_perks = yes # in vi_fake_succession_effects line 565
				copy_traits_xp = yes # in vi_fake_succession_effects line 2456
				copy_stats = yes # in vi_fake_succession_effects line 555
				copy_claims = { OTHER_CHARACTER = scope:source_character } # in vi_fake_succession_effects line 2441
			#	remove_health_traits = yes # in vi_fake_succession_identity_effects line 2203, but makes sense to keep health traits				
				add_character_modifier = { modifier = vi_unnatural_youth_modifier }
				
				# Restore original_identity
				scope:source_character = { save_scope_as = original_identity }
			}
		}
	}

	left_portrait  = { character = scope:original_identity animation = thinking }
	right_portrait = { character = scope:new_identity animation = idle }

	widgets = {
		widget = {
			is_shown = { always = yes }
			gui = "event_window_widget_name_child"
			container = "dynamic_birth_name"
			controller = name_character
			setup_scope = { scope:new_identity = { save_scope_as = name_character_target } }
		}
	}	

	option = {
		name = vi_fake_succession.2011.a
		scope:new_identity = { save_scope_as = new_identity }
		ROOT = {
			save_scope_as = original_identity
			if = {
				limit = { exists = scope:new_identity }
				trigger_event = { 
					id = vi_fake_succession.2012
					delayed = yes
				}
			}
		}
	}
}

vi_fake_succession.2012 = {
	type = character_event
	title = vi_fake_succession.2012.t
	desc = vi_fake_succession.2012.desc
	theme = realm

	left_portrait  = { character = scope:original_identity animation = schadenfreude }
	right_portrait = { character = scope:new_identity      animation = personality_bold }

	option = {
		name = vi_fake_succession.2012.a
		scope:original_identity = {
			save_scope_as = original_identity
			if = {
				limit = { exists = scope:new_identity }
				set_designated_heir = scope:new_identity

			}
		}
		scope:original_identity = {
			save_scope_as = original_identity
			if = {
				limit = { exists = scope:new_identity }
				trigger_event = { 
					id = vi_fake_succession.2013
					delayed = yes
				}
			}
		}
    }
}
vi_fake_succession.2013 = {
	type = character_event
	title = vi_fake_succession.2013.t
	desc  = vi_fake_succession.2013.desc
	theme = death

    left_portrait  = { character = scope:original_identity animation = dead }
    right_portrait = { character = scope:new_identity      animation = schadenfreude }

    option = {
        name = vi_fake_succession.2013.a_peaceful
        scope:original_identity = {
            hidden_effect = {
                death = { death_reason = death_peaceful }
            }
            show_as_tooltip = { death = { death_reason = death_peaceful } }
        }
        scope:new_identity = {
            hidden_effect = {
                add_secret = {
                    type = secret_vi_vampire
                    target = scope:original_identity
                }
            }
        }
        if = {
            limit = { exists = scope:scheme }
            scope:scheme = { end_scheme = yes }
        }
    }

    option = {
        name = vi_fake_succession.2013.a_religious
        scope:original_identity = {
        hidden_effect = {
            death = {
                death_reason = death_martyrdom  # Martyrdom death
            }
        }
        show_as_tooltip = {
            death = { death_reason = death_martyrdom }
        }
        }
        # Create the matching vampire secret on the new identity
        scope:new_identity = {
            hidden_effect = {
                add_secret = {
                    type = secret_vi_vampire
                    target = scope:original_identity
                }
            }
        }
        if = {
            limit = { exists = scope:scheme }
            scope:scheme = { end_scheme = yes }
        }
    }

    option = {
        name = vi_fake_succession.2013.a_murder
        scope:original_identity = {
            hidden_effect = {
                death = {
                    death_reason = death_murder   # Counts as 'murder' for Mandala
                }
            }
            # Public-facing tooltip: shows cause only (no killer)
            show_as_tooltip = {
                death = { death_reason = death_murder }
            }
        }

        scope:new_identity = {
            hidden_effect = {
                add_secret = {
                    type = secret_vi_vampire
                    target = scope:original_identity
                }
            }
        }
        if = {
            limit = { exists = scope:scheme }
            scope:scheme = { end_scheme = yes }
        }
    }
}

# Failure
vi_fake_succession.2020 = {
	type = character_event
	title = vi_fake_succession.2020.t
	desc = vi_fake_succession.2020.desc
	theme = realm
	
	left_portrait = {
		character = root
		animation = rage
	}

	right_portrait = {
		character = scope:vi_vassal
		animation = map_fear
	}

	immediate = {
		save_scope_as = actor

		add_legitimacy = -2000

		vi_secret_exposed_vampire_effect = yes

		show_as_tooltip = {
			add_trait = vi_exposed_vampire
		}

		random_vassal = {
			limit = {
				vi_is_vampire_trigger = no
			}
			save_scope_as = vi_vassal
		}

		if = {
			limit = {
				NOT = {
					exists = scope:vi_vassal
				}
			}
			random_courtier_or_guest = {
				limit = {
					vi_is_vampire_trigger = no
				}
				save_scope_as = vi_vassal
			}
		}
	}

	#Option A: Too bad
    option = {
        name = vi_fake_succession.2020.a
        if = {
            limit = { exists = scope:scheme }
            scope:scheme = { end_scheme = yes }
        }
    }

	after = {
		if = {
			limit = {
				NOT = {
					has_trait = vi_exposed_vampire
				}
			}
			hidden_effect = {
				add_trait = vi_exposed_vampire
			}
			
		}
	}
}